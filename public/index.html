<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="google-site-verification" content="Q2LZeCl8BqgfPfDaWEhXA-i6tRTah6SxI0-ckgeBZZ8"/>
        <link rel="icon" href="/static/img/icon.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/js/utils.js"></script>
        <script src="/static/js/settings.js"></script>
        <title>Snake</title>
    </head>
    <body class="back">
        <div class="container">
            <div class="center">
                <div style="display: none;" id="home" class="content">
                    <div class="title">Snake</div>
                    <br>
                    <div id="buttons" style="animation: back-text 10s ease infinite;"> 
                        <a href="/single"><button class="main-btn" type="button"><span>Play Singleplayer Game</span></button></a><br>
                        <a href="/multi"><button class="main-btn" type="button"><span>Play Multiplayer Game</span></button></a><br>
                        <button onclick="joinGame();" class="main-btn" type="button"><span>Join a Game</span></button><br>
                        <a href="/options"><button class="main-btn" type="button"><span>Options</span></button></a><br>
                    </div>
                </div>

                <div id="single" class="content">
                    <!--<div style="position: absolute; top: 10px; left: 10px; margin: 20px; border: none;" onclick="showPopup();">
                        <img src="/static/img/help-icon.svg" width="50" height="50">
                    </div>-->
                    <div class="title">Play Single Player</div>
                    <form id="singlePlay" style="text-align: center;">
                        <div class="slider-hover">
                            <label for="gameSpeed">Game Speed: <x id="clientGameSpeed"></x>ms</label><div style="height: 5px;"></div>
                            <input style="width: 200px; margin: auto; cursor: auto;" type="range" class="slider" id="gameSpeed" min="20" max="500">
                        </div>
                        <br>
                        <div>
                            <label>Timed</label><br>
                            <input id="timed" type="checkbox">
                        </div>
                        <br>
                        <div class="slider-hover" id="gameTimeArea">
                            <label for="gameTime">Game Time: <x id="clientGameTime"></x>s</label><div style="height: 5px;"></div>
                            <input style="width: 200px; margin: auto; cursor: auto;" type="range" min="30" max="300" id="gameTime" class="slider">
                        </div>
                        <br><br>
                        <x href="/singleSnake"><button class="main-btn" type="submit"><span><b>Play!</b></span></button></x>
                    </form>
                </div>

                <div style="display: none;" id="multi" class="content">
                    <!--<div style="position: absolute; top: 10px; left: 10px; margin: 20px; border: none;" onclick="showPopup(true);">
                        <img src="/static/img/help-icon.svg" width="50" height="50">
                    </div>-->
                    <div class="title">Play Multi Player</div>
                    <form id="multiPlay" style="text-align: center;">
                        <div class="slider-hover">
                            <label for="gameSpeedMulti">Game Speed: <x id="clientGameSpeedMulti">100</x>%</label><div style="height: 5px;"></div>
                            <input style="width: 200px; margin: auto; cursor: auto;" type="range" class="slider" id="gameSpeedMulti" value="0" min="-50" max="50">
                        </div>
                        <br><div class="slider-hover">
                            <label for="gameSpeedMulti">Game Size: <x id="clientGameSizeMulti">100</x>%</label><div style="height: 5px;"></div>
                            <input style="width: 200px; margin: auto; cursor: auto;" type="range" class="slider" id="gameSizeMulti" value="0" min="-50" max="50">
                        </div>
                        <br><br>
                        <x href="/play"><button class="main-btn" type="submit"><span><b>Play!</b></span></button></x>
                    </form>
                </div>

                <div style="display: none;" id="options" class="content">
                    <div class="title">Colours</div>

                    <div id="backClrClick">
                        Backgound Colour<br>
                        <x id="backClr" class="baseColor"></x>
                        <input type="color" id="backClrInp" style="height: 0; width: 0;">
                    </div>
                    <div id="backBordClrClick">
                        Background Border Colour<br>
                        <x id="backBordClr" class="baseColor"></x>
                        <input type="color" id="backBordClrInp" style="height: 0; width: 0;">
                    </div>
                    <br>
                    <div id="foodClrClick">
                        Food Colour<br>
                        <x id="foodClr" class="baseColor"></x>
                        <input type="color" id="foodClrInp" style="height: 0; width: 0;">
                    </div>
                    <div id="foodBordClrClick">
                        Food Border Colour<br>
                        <x id="foodBordClr" class="baseColor"></x>
                        <input type="color" id="foodBordClrInp" style="height: 0; width: 0;">
                    </div>
                    <br>
                    <div id="snakeClrClick">
                        Snake Colour<br>
                        <x id="snakeClr" class="baseColor"></x>
                        <input type="color" id="snakeClrInp" style="height: 0; width: 0;">
                    </div>
                    <div id="snakeBordClrClick">
                        Snake Border Colour<br>
                        <x id="snakeBordClr" class="baseColor"></x>
                        <input type="color" id="snakeBordClrInp" style="height: 0; width: 0;">
                    </div>


                    <div class="title">Controls</div>
                    <button id="upKey" class="main-btn"><span>Up (<x id="upKeyDis"></x>)</span></button>
                    <br>
                    <button id="leftKey" class="main-btn"><span>Left (<x id="leftKeyDis"></x>)</span></button>
                    <button id="rightKey" class="main-btn"><span>Right (<x id="rightKeyDis"></x>)</span></button>
                    <br>
                    <button id="downKey" class="main-btn"><span>Down (<x id="downKeyDis"></x>)</span></button>
                    <br><br><br>
                    <a><button onclick="resetConfig(); reset();" class="main-btn" type="button"><span><b>Reset All</b></span></button></a><a href="/home"><button class="main-btn" type="button"><span><b>Save and Exit</b></span></button></a><br>
                </div>
            </div>
        </div>
        <script>
            const pages = ['/home', '/single', '/multi', '/options'];
            const titles = ['Snake', 'Single Player | Snake', 'Multi Player | Snake', 'Options | Snake', 'Snake'];
            let onload = reset;
            
            $('a').click((ev) => {
                ev.preventDefault();
                history.pushState(null, null, ev.currentTarget.href);
                reset();
            });
            function hideAll() {
                pages.forEach((el) => {
                    $(`${el.replace('/', '#')}`).hide();
                });
            };
            addEventListener('popstate', reset);

            function reset() {
                hideAll();
                if (pages.includes(location.pathname) || location.pathname == '/') {
                    if (location.pathname == '/') {
                        document.title = 'Snake';
                        $('#home').show();
                    }
                    else {
                    document.title = titles[pages.indexOf(location.pathname)];
                        $(`${location.pathname.replace('/', '#')}`).show();
                    };
                }
                else {
                    location.replace('/');
                };

                if (location.search) {
                    let error = location.search;
                    history.replaceState(null, null, '/');
                    if (error == '?a') {
                        Swal.fire({
                            icon: 'error',
                            title: '<h1>404 Error</h1>',
                            html: '<div style="color: white;">Looks like we couldn\'t find the file you wanted, instead we\'ve put you back on the homepage.</div>'
                        });
                    }
                    else if (error == '?b') {
                        Swal.fire({
                            icon: 'error',
                            title: 'The Game ID is inncorrect'
                        });
                    }
                    else if (error == '?c') {
                        Swal.fire({
                            icon: 'error',
                            title: 'The Game has timed out'
                        });
                    }
                    else if (error == '?d') {
                        Swal.fire({
                            icon: 'error',
                            title: 'We have detected that you have entered something into the console.'
                        });
                    };
                };

                let settings = getConfig();

                /* Single Player */
                document.getElementById('gameSpeed').oninput = () => {
                    document.getElementById('clientGameSpeed').innerHTML = document.getElementById('gameSpeed').value;
                    setConfigItem('gameSpeed', document.getElementById('gameSpeed').value);
                };
                settings.gameSpeed ? (() => {
                    document.getElementById('clientGameSpeed').innerHTML = settings.gameSpeed;
                    document.getElementById('gameSpeed').value = settings.gameSpeed;
                })() : (() => {
                    document.getElementById('clientGameSpeed').innerHTML = '100';
                    document.getElementById('gameSpeed').value = 100;
                })();
                document.getElementById('gameTime').oninput = () => {
                    document.getElementById('clientGameTime').innerHTML = document.getElementById('gameTime').value;
                    setConfigItem('gameTime', document.getElementById('gameTime').value);
                };
                if (settings.gameTime == 'off') {
                    document.getElementById('gameTime').disabled = true;
                    document.getElementById('timed').checked = false;
                    document.getElementById('gameTimeArea').style.opacity = 0.5;
                    document.getElementById('clientGameTime').innerHTML = '120';
                    document.getElementById('gameTime').value = 120;
                }
                else {
                    document.getElementById('clientGameTime').innerHTML = settings.gameTime;
                    document.getElementById('gameTime').value = settings.gameTime;
                    document.getElementById('timed').checked = true;
                };

                document.getElementById('timed').oninput = () => {
                    document.getElementById('timed').checked ? (() => {
                        document.getElementById('gameTime').disabled = false;
                        document.getElementById('gameTimeArea').style.opacity = 1;
                        document.getElementById('clientGameTime').innerHTML = Number.isInteger(parseInt(getConfig().gameTime)) ? getConfig().gameTime : 120;
                        document.getElementById('gameTime').value = Number.isInteger(parseInt(getConfig().gameTime)) ? getConfig().gameTime : 120;
                    })() : (() => {
                        document.getElementById('gameTime').disabled = true;
                        document.getElementById('gameTimeArea').style.opacity = 0.5;
                        document.getElementById('clientGameTime').innerHTML = Number.isInteger(parseInt(getConfig().gameTime)) ? getConfig().gameTime : 120; 
                        document.getElementById('gameTime').value = Number.isInteger(parseInt(getConfig().gameTime)) ? getConfig().gameTime : 120;  
                    })();
                }

                document.getElementById('singlePlay').onsubmit = (ev) => {
                    ev.preventDefault();
                    let playSettings = getConfig();
                    playSettings.gameSpeed = document.getElementById('gameSpeed').value;
                    playSettings.gameTime = document.getElementById('timed').checked ? document.getElementById('gameTime').value : 'off';
                    setConfig(playSettings);
                    location.href = '/singleSnake';
                };


                /* Multi player */
                function setSettings(gameSpeed, gameSize) {
                    let percentage = 1;
                    let value = parseInt(gameSize);
                    percentage = (value / 100) + 1;
                    gameSize = 40 * percentage;


                    percentage = 1;
                    value = parseInt(gameSpeed);
                    if (Math.sign(value) == 1) {
                        value = value - (2 * value);
                        percentage = (value / 100) + 1;
                    }
                    else if (Math.sign(value) == -1) {
                        value = value + Math.abs(2 * value);
                        percentage = (value / 100) + 1;
                    };
                    gameSpeed = (1000 / ((1000 / gameSize) / 2)) * percentage;
                    return {
                        gameSpeed: gameSpeed,
                        gameSize: gameSize
                    };
                };

                document.getElementById('gameSpeedMulti').oninput = () => {
                    document.getElementById('clientGameSpeedMulti').innerHTML = parseInt(document.getElementById('gameSpeedMulti').value) + 100;

                    let multiSettings = setSettings(document.getElementById('gameSpeedMulti').value, document.getElementById('gameSizeMulti').value);
                    setConfigItem('gameSpeed', multiSettings.gameSpeed);
                    setConfigItem('gameSize', multiSettings.gameSize);
                };


                document.getElementById('gameSizeMulti').oninput = () => {
                    document.getElementById('clientGameSizeMulti').innerHTML = parseInt(document.getElementById('gameSizeMulti').value) + 100;

                    let multiSettings = setSettings(document.getElementById('gameSpeedMulti').value, document.getElementById('gameSizeMulti').value);
                    setConfigItem('gameSpeed', multiSettings.gameSpeed);
                    setConfigItem('gameSize', multiSettings.gameSize);
                };

                document.getElementById('gameSpeedMulti').oninput();
                document.getElementById('gameSizeMulti').oninput();
                

                document.getElementById('multiPlay').onsubmit = (ev) => {
                    ev.preventDefault();
                    location.href = `/start/snake/${getConfig().gameSpeed}/${getConfig().gameSize}`;
                };



                /* Options */
                const clrInps = [
                    {color: document.getElementById('backClr'), click: document.getElementById('backClrClick'), inp: document.getElementById('backClrInp'), settingName: 'canvasBackgroundColour'},
                    {color: document.getElementById('backBordClr'), click: document.getElementById('backBordClrClick'), inp: document.getElementById('backBordClrInp'), settingName: 'canvasBorderColour'},
                    {color: document.getElementById('foodClr'), click: document.getElementById('foodClrClick'), inp: document.getElementById('foodClrInp'), settingName: 'foodColour'},
                    {color: document.getElementById('foodBordClr'), click: document.getElementById('foodBordClrClick'), inp: document.getElementById('foodBordClrInp'), settingName: 'foodBorderColour'},
                    {color: document.getElementById('snakeClr'), click: document.getElementById('snakeClrClick'), inp: document.getElementById('snakeClrInp'), settingName: 'snakeColour'},
                    {color: document.getElementById('snakeBordClr'), click: document.getElementById('snakeBordClrClick'), inp: document.getElementById('snakeBordClrInp'), settingName: 'snakeBorderColour'}
                ];
                clrInps.forEach((el) => {
                    el.click.onclick = () => {
                        el.inp.click();
                    };
                    el.inp.oninput = () => {
                        el.color.style.background = el.inp.value;
                        setConfigItem(el.settingName, el.inp.value)
                    };
                    el.inp.value = settings[el.settingName];
                    el.color.style.background = settings[el.settingName];
                });

                const keyInps = [
                    {button: document.getElementById('upKey'), dis: document.getElementById('upKeyDis'), name: 'up'},
                    {button: document.getElementById('leftKey'), dis: document.getElementById('leftKeyDis'), name: 'left'},
                    {button: document.getElementById('rightKey'), dis: document.getElementById('rightKeyDis'), name: 'right'},
                    {button: document.getElementById('downKey'), dis: document.getElementById('downKeyDis'), name: 'down'}
                ];
                keyInps.forEach((el) => {
                    function keyDown(ev) {
                        setConfigItem(el.name, ev.keyCode);
                        setConfigItem(`${el.name}Key`, ev.key);
                        el.dis.innerHTML = ev.key;
                    }
                    el.button.addEventListener('keydown', keyDown)
                    el.dis.innerHTML = settings[`${el.name}Key`];
                });
            };

            /*function showPopup (param) {
                param ? (() => {
                    Swal.fire({
                        icon: 'info',
                        html: '<div style="font-size: medium; color: grey;"><b style="font-size: large; color: white;">Game Speed</b><br>Game speed is how often the snake will move. 1000ms are equal to 1 second.</div>'
                    });
                })() : (() => {
                    Swal.fire({
                        icon: 'info',
                        html: '<div style="font-size: medium; color: grey;"><b style="font-size: large; color: white;">Game Speed</b><br>Game speed is how often the snake will move. 1000ms are equal to 1 second.<br><b style="font-size: large; color: white;">Game Time</b><br>Game is how long the game will last for.</div>'
                    });
                })();
            };*/


            function joinGame() {
                Swal.fire({
                    title: 'Enter your Game ID',
                    input: 'text',
                    inputAttributes: {
                        autocapitalize: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Join',
                    showLoaderOnConfirm: true,
                    preConfirm: (id) => {
                        return fetch(`/api?${id}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(response.statusText);
                            };
                            return response.json();
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Looks like that Game ID doesn't exist`);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                })
                .then((result) => {
                    if (result.isConfirmed) {
                        location.href = `/play/${result.value.id}`;
                    };
                });
            };
        </script>
    </body>
</html>