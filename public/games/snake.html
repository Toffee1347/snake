<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="google-site-verification" content="Q2LZeCl8BqgfPfDaWEhXA-i6tRTah6SxI0-ckgeBZZ8"/>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/js/utils.js"></script>
        <script src="/static/js/settings.js"></script>
        <script src="/static/js/multiGameClass.js"></script>
        <title>Multi-player Game | Snakeee</title>
        <style>
            body {
                overscroll-behavior: contain;
            }
        </style>
    </head>
    <body style="overflow: hidden; display: inline-block;" class="back" onbeforeunload="emits.emit('playerDisconnect', location.pathname.split('/')[2])">
        <div class="window" style="bottom: -100%; z-index: 999;" id="options">
            <div class="center" style="position: relative;">
                <div style="width: 80vw; height: 80vh; border: 2px solid black; z-index: 2; position: absolute;">
                    <img id="close" width="30" height="30" src="/static/img/close-icon.svg" style="cursor: pointer; right: 20px; top: 10px; margin: 10px; z-index: 1; position: inherit;">
                    <div style="position: relative; width: 100%; height: 100%;">
                        <iframe id="iframe" style="width: 100%; height: 100%;" src="/snakeBuilder.html"></iframe>
                    </div>
                </div>
                <div style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;" id="listener"></div>
            </div>
        </div>
        <div style="top: 0; bottom: 0;" class="window" id="game">
            <div style="width: 100%; height: 100%; z-index: 99; position: absolute; top: 0; left: 0; pointer-events: none;" id="tint"></div>
            <div style="position: relative;">
                <div class="center">
                    <div class="center-inner">
                        <div class="game">
                            <canvas id="gameCanvas" width="1000" height="1000" style="width: 50vh; height: 50vh; padding: 15px;">Your browser doesn't support canvases!</canvas>
                        </div>
                        <div onclick="toggleFullScreen();" class="fullscreen" nontouch>
                            <img title="Full Screen" src="/static/img/fullscreen-icon.svg" width="50" height="50" nontouch>
                        </div>
                        <div style="cursor: pointer;" class="player-count" onclick="copy(location.href); copied();">
                            Game ID: <x id="gameId">0000</x><br>
                            Player Count: <x id="playerCount">0</x><br>
                            Size: <x id="size">0</x><br>
                            Click to Copy Link
                        </div>
                        <div id="customise" style="cursor: pointer; text-align: center;" title="Snake Builder" class="copy">
                            <img width="20" height="20" src="/static/img/art-icon.png">
                            <br>
                            <small>Snake Builder</small>
                        </div>
                        <div id="restart" onclick="restart();" class="multi-reset" style="display: none;">
                            <img width="50" height="50" src="/static/img/restart-icon.svg">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            async function onload() {
                let gameId = location.pathname.split('/')[2];
                document.getElementById('gameId').innerHTML = gameId;
                emits.on('redirect', (body) => {
                    location.replace(body);
                });
                emits.on('gameExists', async (body) => {
                    let turning = false;
                    const {value: username} = await Swal.fire({
                        title: 'Please enter a username',
                        input: 'text',
                        showCancelButton: false,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        inputValidator: (value) => {
                            if (!value || (value.length > 10)) {
                                return 'Please enter a username with less that 10 characters';
                            };
                        }
                    });
                    window.username = username;
                    emits.emit('snakeJoinWithName', {
                        gameId: gameId,
                        name: username,
                        settings: getConfig()
                    });
                    onresize = () => {
                        if (innerHeight > innerWidth) {
                            document.getElementById('gameCanvas').style.width = '80vw';
                            document.getElementById('gameCanvas').style.height = '80vw';
                        }
                        else {
                            document.getElementById('gameCanvas').style.width = '80vh';
                            document.getElementById('gameCanvas').style.height = '80vh';
                        };
                    };
                    onresize();
                    
                    let canvas = new MultiCanvas('gameCanvas', getConfig(), body);
                    emits.on('snakePing', (body) => {
                        turning = false;
                        canvas.drawGame(body);
                    });
                    emits.on('snakeDeath', () => {
                        Swal.fire({
                            html: `<div style="font-size: large; color: white;"><b>You lost!</b></div><br><div style="font-size: small; color: light-grey;">Your score was ${document.getElementById('size').innerHTML}</div><br><large style="font-size: large;">Would you like to play again?</large><br><br><button type="button" class="swal2-confirm swal2-styled" style="display: inline-block; border: none;" aria-label="" onclick="Swal.close(); restart();">Yes</button><button type="button" class="swal2-confirm swal2-styled" style="display: inline-block; border: none;" aria-label="" onclick="Swal.close(); $('#restart').show();">No</button>`,
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });
                    });
                    emits.on('playerCount', (body) => {
                        document.getElementById('playerCount').innerHTML = body;
                    });
                    emits.on('playerSize', (body) => {
                        document.getElementById('size').innerHTML = body;
                    });
                    emits.on('setImage', (body) => {
                        canvas.setImage(body.id, body.image);
                    });
                    emits.on('initImages', (body) => {
                        Object.keys(body).forEach((el) => {
                            canvas.setImage(el, body[el]);
                        });
                    });
                    
                    
                    document.addEventListener('keydown', (key) => {
                        if (!turning && !key.repeat) {
                            turning = true;
                            const settings = getConfig();
                            const inpMap = {
                                [settings.up]: 'up',
                                [settings.down]: 'down',
                                [settings.left]: 'left',
                                [settings.right]: 'right'
                            };
                            if (key.keyCode in inpMap) {
                                emits.emit('snakeMove', {gameId: location.pathname.split('/')[2], dir: inpMap[key.keyCode]});
                            };
                        };
                    });


                    function touchEnd(from, to) {
                        let settings = getConfig();
                        const mouseDiff = {
                            x: from.x - to.x,
                            y: from.y - to.y
                        };
                        if (Math.abs(mouseDiff.x) > Math.abs(mouseDiff.y)) {
                            if (Math.abs(mouseDiff.x) < screenX/10) return;
                            if (Math.sign(mouseDiff.x) == 1) {
                                emits.emit('snakeMove', {gameId: location.pathname.split('/')[2], dir: 'left'});
                            }
                            else if (Math.sign(mouseDiff.x) == -1) {
                                emits.emit('snakeMove', {gameId: location.pathname.split('/')[2], dir: 'right'});
                            };
                        }
                        else if (Math.abs(mouseDiff.x) < Math.abs(mouseDiff.y)) {
                            if (Math.abs(mouseDiff.y) < screenY/10) return;
                            if (Math.sign(mouseDiff.y) == 1) {
                                emits.emit('snakeMove', {gameId: location.pathname.split('/')[2], dir: 'up'});
                            }
                            else if (Math.sign(mouseDiff.y) == -1) {
                                emits.emit('snakeMove', {gameId: location.pathname.split('/')[2], dir: 'down'});
                            };
                        };
                    };
                    let touch = {};
                    document.addEventListener('touchstart', (ev) => {
                        touch = {
                            x: ev.touches[0].clientX,
                            y: ev.touches[0].clientY
                        };
                    });
                    document.addEventListener('touchend', (ev) => {
                        touchEnd(touch, {
                            x: ev.changedTouches[0].clientX,
                            y: ev.changedTouches[0].clientY
                        });
                    });
                });
                emits.emit('snakeJoin', gameId);
            };
            function toggleFullScreen() {
                if (document.webkitIsFullScreen || document.mozFullScreen || document.fullscreen || false) {
                    document.exitFullscreen();
                }
                else {
                    document.documentElement.requestFullscreen();
                };
            };
            function restart() {
                $('#restart').hide();
                emits.emit('snakeRejoin', location.pathname.split('/')[2]);
            };
            function copied() {
                Swal.fire({
                    position: 'bottom-start',
                    icon: 'success',
                    title: 'Copied to clipboard',
                    showConfirmButton: false,
                    timer: 1000,
                    backdrop: false,
                    timerProgressBar: true
                });
            };
            document.getElementById('customise').onclick = () => {
                let closed = false;
                emits.emit('playerDisconnect', location.pathname.split('/')[2]);
                document.getElementById('options').style.bottom = '0%';
                document.getElementById('tint').style.opacity = '0.5';
                document.getElementById('tint').style.backgroundColor = 'black';
                document.getElementById('close').onclick = close;
                document.getElementById('listener').onclick = close;
                function close() {
                    if (!closed) {
                        closed = true;
                        document.getElementById('options').style.bottom = '-100%';
                        document.getElementById('tint').style.opacity = '0';
                        emits.emit('snakeJoinWithName', {
                            gameId: location.pathname.split('/')[2],
                            name: username,
                            settings: getConfig()
                        });
                        document.getElementById('gameCanvas').click();
                    };
                }
            };
        </script>
    </body>
</html>