<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="google-site-verification" content="Q2LZeCl8BqgfPfDaWEhXA-i6tRTah6SxI0-ckgeBZZ8"/>
        <link rel="icon" href="/static/img/icon.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/js/utils.js"></script>
        <script src="/static/js/settings.js"></script>
        <script src="/static/js/multiGameClass.js"></script>
        <title>Multi-player Game | Snake</title>
        <style>
            body {
                overscroll-behavior: contain;
            }
        </style>
    </head>
    <body style="overflow-x: hidden;" class="back" onbeforeunload="emits.emit('playerDisconnect', location.pathname.split('/')[2])">
        <div class="center">
            <div class="center-inner">
                <div class="game">
                    <canvas id="gameCanvas" width="1000" height="1000" style="width: 50vh; height: 50vh; padding: 15px;">Your browser doesn't support canvases!</canvas>
                </div>
                <div onclick="toggleFullScreen();" class="fullscreen" nontouch>
                    <img title="Full Screen" src="/static/img/fullscreen-icon.svg" width="50" height="50" nontouch>
                </div>
                <div class="player-count">
                    Game ID: <x id="gameId">0000</x><br>
                    Player Count: <x id="playerCount">0</x><br>
                    Size: <x id="size">0</x>
                </div>
                <div class="copy">
                    <button style="margin: 0px;" type="button" class="main-btn" onclick="copy(location.href); copied();"><span>Copy Link</span></button>
                </div>
                <div id="restart" onclick="restart();" class="multi-reset" style="display: none;">
                    <img width="50" height="50" src="/static/img/restart-icon.svg">
                </div>
            </div>
        </div>
        <script>
            async function onload() {
                let gameId = location.pathname.split('/')[2];
                document.getElementById('gameId').innerHTML = gameId;
                emits.on('redirect', (body) => {
                    location.replace(body);
                });
                emits.on('gameExists', async (body) => {
                    const {value: username} = await Swal.fire({
                        title: 'Please enter a username',
                        input: 'text',
                        showCancelButton: false,
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Please enter a username';
                            };
                        }
                    });
                    emits.emit('snakeJoinWithName', {
                        gameId: gameId,
                        name: username,
                        settings: getConfig()
                    });
                    onresize = () => {
                        if (innerHeight > innerWidth) {
                            document.getElementById('gameCanvas').style.width = '80vw';
                            document.getElementById('gameCanvas').style.height = '80vw';
                        }
                        else {
                            document.getElementById('gameCanvas').style.width = '80vh';
                            document.getElementById('gameCanvas').style.height = '80vh';
                        }
                    };
                    onresize();
                    let canvas = new MultiCanvas('gameCanvas', getConfig(), body);
                    emits.on('snakePing', (body) => {
                        canvas.drawGame(body);
                    });
                    emits.on('snakeDeath', () => {
                        Swal.fire({
                            html: `<div style="font-size: large; color: white;"><b>You lost!</b></div><br><div style="font-size: small; color: light-grey;">Your score was ${document.getElementById('size').innerHTML}</div><br><large style="font-size: large;">Would you like to play again?</large><br><br><button type="button" class="swal2-confirm swal2-styled" style="display: inline-block; border: none;" aria-label="" onclick="Swal.close(); restart();">Yes</button><button type="button" class="swal2-confirm swal2-styled" style="display: inline-block; border: none;" aria-label="" onclick="Swal.close(); $('#restart').show();">No</button>`,
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            allowEnterKey: false
                        });
                    });
                    emits.on('playerCount', (body) => {
                        document.getElementById('playerCount').innerHTML = body;
                    });
                    emits.on('playerSize', (body) => {
                        document.getElementById('size').innerHTML = body;
                    });
                    
                    function move(key) {
                        const settings = getConfig();
                        if (key.keyCode == settings.up) {
                            emits.emit('snakeUp', location.pathname.split('/')[2]);
                        }
                        else if (key.keyCode == settings.down) {
                            emits.emit('snakeDown', location.pathname.split('/')[2]);
                        }
                        else if (key.keyCode == settings.left) {
                            emits.emit('snakeLeft', location.pathname.split('/')[2]);
                        }
                        else if (key.keyCode == settings.right) {
                            emits.emit('snakeRight', location.pathname.split('/')[2]);
                        };
                    };
                    document.addEventListener('keydown', move);


                    function touchEnd(from, to) {
                        let settings = getConfig();
                        const mouseDiff = {
                            x: from.x - to.x,
                            y: from.y - to.y
                        };
                        if (Math.abs(mouseDiff.x) > Math.abs(mouseDiff.y)) {
                            if (Math.abs(mouseDiff.x) < screenX/10) return;
                            if (Math.sign(mouseDiff.x) == 1) {
                                move({keyCode:settings.left});
                            }
                            else if (Math.sign(mouseDiff.x) == -1) {
                                move({keyCode:settings.right});
                            };
                        }
                        else if (Math.abs(mouseDiff.x) < Math.abs(mouseDiff.y)) {
                            if (Math.abs(mouseDiff.y) < screenY/10) return;
                            if (Math.sign(mouseDiff.y) == 1) {
                                move({keyCode:settings.up});
                            }
                            else if (Math.sign(mouseDiff.y) == -1) {
                                move({keyCode:settings.down});
                            };
                        };
                    };
                    let touch = {};
                    document.addEventListener('touchstart', (ev) => {
                        touch = {
                            x: ev.touches[0].clientX,
                            y: ev.touches[0].clientY
                        };
                    });
                    document.addEventListener('touchend', (ev) => {
                        touchEnd(touch, {
                            x: ev.changedTouches[0].clientX,
                            y: ev.changedTouches[0].clientY
                        });
                    });
                });
                emits.emit('snakeJoin', gameId);
            };
            function toggleFullScreen() {
                if (document.webkitIsFullScreen || document.mozFullScreen || document.fullscreen || false) {
                    document.exitFullscreen();
                }
                else {
                    document.documentElement.requestFullscreen();
                };
            };
            function restart() {
                $('#restart').hide();
                emits.emit('snakeRejoin', location.pathname.split('/')[2]);
            };
            function copied() {
                Swal.fire({
                    position: 'bottom-start',
                    icon: 'success',
                    title: 'Copied to clipboard',
                    showConfirmButton: false,
                    timer: 1000,
                    backdrop: false,
                    timerProgressBar: true
                });
            };
        </script>
    </body>
</html>