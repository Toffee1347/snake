<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Trispace'>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-detect@1.4.4/mobile-detect.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tsparticles/1.18.1/tsparticles.min.js" integrity="sha512-PYHWDEuXOTJ9MZ+/QHqkbgiEYZ+LImQv3i/9NyYOABFvK37e4q4Wg7aQDN1JpoGiEu1TYZh6JMrZluZox2gbDA==" crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/token_script.js"></script>
    <title>Snake</title>
    <style>
        body {
            overscroll-behavior: contain;
        }
    </style>
</head>
<body style="margin: 0px;">
    <div id="particles-js"></div>
    <div id="loading">
        <div class="container">
            <div class="center">
                <div class="content">
                    <p>Waiting for player two</p>
                    <p id="game_id"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="game">
        <div class="center">
            <div class="row">
                <div style="text-align: center;" class="col-md-6">
                    <div class="game" id="client">
                        <div style="padding: 20px; padding-bottom: 17px;"><div style="float: left;">Score: <x id="client_score">0</x></div><div style="float: right;">Time: <x id="client_time">00:00</x></div></div><br>
                        <canvas id="client_canvas" width="300" height="300">Your browser doesn't support canvases!</canvas>
                    </div>
                </div>
                <div style="text-align: center;" class="col-md-6">
                    <div class="game" id="server">
                        <div style="padding: 20px; padding-bottom: 17px;"><div style="float: left;">Score: <x id="server_score">0</x></div><div style="float: right;">Time: <x id="server_time">00:00</x></div></div><br>
                        <canvas id="server_canvas" width="300" height="300">Your browser doesn't support canvases!</canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('click', () => {
            document.documentElement.requestFullscreen()
        })
        let origMouse
        document.addEventListener('touchstart', (e) => {mouseDown(e.touches[0].clientX, e.touches[0].clientY)})
        document.addEventListener('touchend', (e) => {mouseUp(e.changedTouches[0].clientX, e.changedTouches[0].clientY)})
        document.addEventListener('touchmove', () => {document.documentElement.requestFullscreen()})
        function mouseDown(x, y) {
            origMouse = {
                X:x,
                Y:y
            }
        }
        function mouseUp(x, y) {
            const mouseDiff = {
                x:origMouse.X - x,
                y:origMouse.Y - y
            }
            if (Math.abs(mouseDiff.x) > Math.abs(mouseDiff.y)) {
                if (Math.abs(mouseDiff.x) < screenX/10) return
                if (Math.sign(mouseDiff.x) == 1) {
                    change_direction({keyCode:localStorage.getItem('left')})
                }
                else if (Math.sign(mouseDiff.x) == -1) {
                    change_direction({keyCode:localStorage.getItem('right')})
                }
            }
            else if (Math.abs(mouseDiff.x) < Math.abs(mouseDiff.y)) {
                if (Math.abs(mouseDiff.y) < screenY/10) return
                if (Math.sign(mouseDiff.y) == 1) {
                    change_direction({keyCode:localStorage.getItem('up')})
                }
                else if (Math.sign(mouseDiff.y) == -1) {
                    change_direction({keyCode:localStorage.getItem('down')})
                }
            }
        }
        let game_speed
        let game_time
        let game_id
        async function page_onload() {
            $('#game').hide()
            game_id = window.location.hash.replace('#', '')
            document.getElementById('game_id').innerHTML = `Game ID: ${game_id}`
            if (!game_id) return window.location.href = '/multi/start'
            if (game_id.match(/^[0-9]+$/)) return window.location.href = '/multi/start'
            await set_start()
            emits.emit('multi_join_game', {game_id:game_id})
            emits.on('multi_server_player_move', (body, token) => {
                server.snake = body.snake
                server.food = body.food
                server.score = body.score
            })
            emits.on('server_game_end', (body, token) => {
                alert(`You ${body}!`)
                return window.location.href = '/multi/start'
            })
            emits.on('invalid_code', (body, token) => {
                window.location.href = '/multi/start'
            })
            let mobile = new MobileDetect(window.navigator.userAgent)
            if (mobile.phone()) { 
                document.getElementById('server_canvas').style.height = screen.availHeight/7 + 'px'
                document.getElementById('client_canvas').style.height = screen.availHeight/4 + 'px'

            }
        }
        async function set_start() {
            await emits.on('start_game', (body, token) => {
                game_speed = body.game_speed
                game_time = body.game_time
                $('#game').show()
                $('#loading').hide()
                start_game()
                server_start()
                start_countdown()
                server_countdown()
            })
            return true
        }
        function start_countdown() {
            let timeCount = 0
            let timerID = setInterval(() => {
                if (game_time <= timeCount) {
                    emits.emit('client_game_end_time', game_id)
                }
                timeCount++
                timer = new Date(game_time * 1000 - timeCount * 1000)
                document.getElementById('client_time').innerHTML = `0${timer.getMinutes()}`.slice(-2) + ':' + `0${timer.getSeconds()}`.slice(-2)
            }, 1000)
        }
        function server_countdown() {
            let timeCount = 0
            let timerID = setInterval(() => {
                if (game_time <= timeCount) {
                    emits.emit('client_game_end_time', game_id)
                }
                timeCount++
                timer = new Date(game_time * 1000 - timeCount * 1000)
                document.getElementById('server_time').innerHTML = `0${timer.getMinutes()}`.slice(-2) + ':' + `0${timer.getSeconds()}`.slice(-2)
            }, 1000)
        }
        function server_start() {
            setTimeout(() => {
                server.clear_canvas()
                server.draw_snake(server.snake)
                server.draw_food(server.food)
                server.set_score(server.score)
                server_start()
            }, game_speed)
        }
    </script>
    <script>
        let snake = [
            {x: 150, y: 150},
            {x: 140, y: 150},
            {x: 130, y: 150},
            {x: 120, y: 150},
            {x: 110, y: 150}
        ]
        let food = {
            x:'',
            y:''
        }
        let score = 0
        let changeing_direction = false
        let d = {
            x:10,
            y:0
        }
        let required_settings = [
            ['game_speed', 250],
            ['canvas_border_colour', '#000000'],
            ['canvas_background_colour', '#ffffff'],
            ['snake_colour', '#90ee90'],
            ['snake_border_colour', '#013220'],
            ['food_colour', '#ff0000'],
            ['food_border_colour', '#8b0000'],
            ['up', 38],
            ['down', 40],
            ['left', 37],
            ['right', 39],
            ['up_key', 'ArrowUp'],
            ['down_key', 'ArrowDown'],
            ['left_key', 'ArrowLeft'],
            ['right_key', 'ArrowRight'],
            ['game_time', 120]
        ]
        let settings = {
            game_speed:250,
            canvas_border_colour:'#000000',
            canvas_background_colour:'#ffffff',
            snake_colour:'#90ee90',
            snake_border_colour:'#013220',
            food_colour:'#ff0000',
            food_border_colour:'#8b0000',
            up:38,
            down:40,
            left:37,
            right:39,
            up_key:'ArrowUp',
            down_key:'ArrowDown',
            left_key:'ArrowLeft',
            right_key:'ArrowRight',
            game_time:120
        }
        for (const x of required_settings) {
            if (!localStorage.getItem(x[0])) {
                localStorage.setItem(x[0], x[1])
            }
            else {
                settings[x[0]] = localStorage.getItem(x[0])
            }
        }
        function add_score(amount) {
            score += amount
            document.getElementById('client_score').innerHTML = score
        }
        const canvas = document.getElementById('client_canvas')
        const ctx = canvas.getContext("2d")

        function start_game() {
            clear_canvas()
            server.clear_canvas()
            run_game()
            create_food()
            document.addEventListener('keydown', change_direction)
        }

        function run_game() {
            if (did_game_end()) {
                return emits.emit('client_game_end', game_id)
            }
            setTimeout(() => {
                changeing_direction = false
                clear_canvas()
                draw_food()
                advance_snake()
                draw_snake()
                emits.emit('multi_game_tick', {game_id:game_id, game:{snake:snake, food:food, score:score}})
                run_game()
            }, game_speed)
        }
        function clear_canvas() {
            ctx.fillStyle = settings.canvas_background_colour
            ctx.strokeStyle = settings.canvas_border_colour
            ctx.fillRect(0, 0, canvas.width, canvas.height)
            ctx.strokeRect(0, 0, canvas.width, canvas.height)
        }
        function draw_food() {
            ctx.fillStyle = settings.food_colour
            ctx.strokeStyle = settings.food_border_colour
            ctx.fillRect(food.x, food.y, 10, 10)
            ctx.strokeRect(food.x, food.y, 10, 10)
        }
        function advance_snake() {
            snake.unshift({x:snake[0].x + d.x, y:snake[0].y + d.y})
            if (snake[0].x === food.x && snake[0].y === food.y) {
                add_score(10)
                create_food()
            }
            else {
                snake.pop()
            }
        }
        function did_game_end() {
            for (let i = 4; i < snake.length; i++) {
                if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) {
                    return true
                }
                const hit = {
                    left_wall: snake[0].x < 0,
                    right_wall: snake[0].x > canvas.width - 10,
                    top_wall: snake[0].y < 0,
                    bottom_wall: snake[0].y > canvas.height - 10
                }
                return hit.left_wall || hit.right_wall || hit.top_wall || hit.bottom_wall
            }
        }
        function random(min, max) {
            return Math.round((Math.random() * (max-min) + min) / 10) * 10;
        }
        function create_food() {
            food.x = random(0, canvas.width - 10)
            food.y = random(0, canvas.height - 10)
            snake.forEach((part) => {
                if (part.x === food.x && part.y === food.y) create_food()
            })
        }
        function draw_snake() {
            snake.forEach(draw_snake_part)
        }
        function draw_snake_part(part) {
            ctx.fillStyle = settings.snake_colour
            ctx.strokeStyle = settings.snake_border_colour
            ctx.fillRect(part.x, part.y, 10, 10)
            ctx.strokeRect(part.x, part.y, 10, 10)
        }
        function change_direction(event) {
            if (changeing_direction) return;
            changeing_direction = true
            if (event.keyCode == settings.up && d.y != 10) {
                d = {
                    x:0,
                    y:-10
                }
            }
            if (event.keyCode == settings.down && d.y != -10) {
                d = {
                    x:0,
                    y:10
                }
            }
            if (event.keyCode == settings.left && d.x != 10) {
                d = {
                    x:-10,
                    y:0
                }
            }
            if (event.keyCode == settings.right && d.x != -10) {
                d = {
                    x:10,
                    y:0
                }
            }
        }

        const server_canvas = document.getElementById('server_canvas')
        const server_ctx = server_canvas.getContext('2d')
        let server = {
            clear_canvas:() => {
                server_ctx.fillStyle = settings.canvas_background_colour
                server_ctx.strokeStyle = settings.canvas_border_colour
                server_ctx.fillRect(0, 0, canvas.width, canvas.height)
                server_ctx.strokeRect(0, 0, canvas.width, canvas.height)
            },
            draw_snake:(snake) => {
                snake.forEach(server.draw_snake_part)
            },
            draw_snake_part:(part) => {
                server_ctx.fillStyle = settings.snake_colour
                server_ctx.strokeStyle = settings.snake_border_colour
                server_ctx.fillRect(part.x, part.y, 10, 10)
                server_ctx.strokeRect(part.x, part.y, 10, 10)
            },
            draw_food:(food) => {
                server_ctx.fillStyle = settings.food_colour
                server_ctx.strokeStyle = settings.food_border_colour
                server_ctx.fillRect(food.x, food.y, 10, 10)
                server_ctx.strokeRect(food.x, food.y, 10, 10)
            },
            set_score:(amount) => {
                document.getElementById('server_score').innerHTML = amount
            },
            snake:[],
            food:{},
            score:0
        }
    </script>
</body>
</html>